# ═══════════════════════════════════════════════════════════════════
# AUTO Z-OFFSET MESSUNG - KONFIGURATIONSDATEI
# ═══════════════════════════════════════════════════════════════════
# Diese Datei enthält alle Variablen für die Python-basierte
# Auto-Offset-Messung (auto_offset.py in klipper/klippy/extras/)
#
# WICHTIG: Nach Änderungen an dieser Datei: RESTART (nicht FIRMWARE_RESTART!)
# ═══════════════════════════════════════════════════════════════════

[auto_offset]
# ═══════════════════════════════════════════════════════════════════
# ALLGEMEINE EINSTELLUNGEN
# ═══════════════════════════════════════════════════════════════════
debug_level: 0                               # Debug-Ausgaben (0=aus, 1=normal, 2=verbose)
show_warnings: 1                             # Warnungen anzeigen (0=aus, 1=an)
led_name: Licht                              # Name des LED-Strips für Statusanzeige
clean_macro: BLOBIFIER_CLEAN                 # Makro für Düsenreinigung vor der Messung

# Probe-Referenz (für QUERY_PROBE_SILENT)
reference: probe                             # Welche Probe nutzen (Standard: probe)

# ═══════════════════════════════════════════════════════════════════
# ABLAUFSTEUERUNG - Enable/Disable Flags für Messphasen
# ═══════════════════════════════════════════════════════════════════
temp_enable: 1                               # Heizen vor Messung (1=aktiv, 0=überspringen)
qgl_enable: 1                                # Quad Gantry Leveling (1=aktiv, 0=überspringen)
clean_enable: 1                              # Düsenreinigung (1=aktiv, 0=überspringen)
accuracy_check_enable: 1                     # Genauigkeitstest vor Messung (1=aktiv, 0=überspringen)
trigger_distance_enable: 1                   # Schaltabstandsmessung (1=aktiv, 0=überspringen)
offset_measure_enable: 1                     # Sensor-Offset-Messung (1=aktiv, 0=überspringen)

# ═══════════════════════════════════════════════════════════════════
# POSITIONS- UND BEWEGUNGSPARAMETER
# ═══════════════════════════════════════════════════════════════════
# Parkposition (nach erfolgreicher Messung)
park_x: 175.0                                # X-Koordinate der Parkposition
park_y: 350.0                                # Y-Koordinate der Parkposition
park_z: 20.0                                 # Z-Höhe der Parkposition

# Messposition (wo die Messung durchgeführt wird)
measure_x: 251.0                             # X-Koordinate der Messposition
measure_y: 357.0                             # Y-Koordinate der Messposition
measure_z: 5.0                               # Start-Z-Höhe über dem Bett

# ═══════════════════════════════════════════════════════════════════
# TEMPERATUR-PARAMETER
# ═══════════════════════════════════════════════════════════════════
preheat_nozzle_temp: 150                     # Düsentemperatur zum Vorheizen (°C)
preheat_bed_temp: 110                        # Betttemperatur zum Vorheizen (°C)

# ═══════════════════════════════════════════════════════════════════
# PHASE 1: GENAUIGKEITSTEST (PROBE_ACCURACY)
# ═══════════════════════════════════════════════════════════════════
probe_samples: 5                             # Anzahl der Wiederholmessungen
probe_z_start: 2.0                           # Start-Z-Höhe für den Test (mm)
probe_tolerance: 0.020                       # Max. erlaubte Abweichung (mm)
probe_speed: 1                               # Verfahrgeschwindigkeit (mm/s)

# ═══════════════════════════════════════════════════════════════════
# PHASE 2: SCHALTABSTANDSMESSUNG (TRIGGER_DISTANCE) 
# ═══════════════════════════════════════════════════════════════════
trigger_distance_max: 0.25                   # Maximaler Hub für Release-Erkennung (mm)

# ═══════════════════════════════════════════════════════════════════
# PHASE 3: SENSOR-OFFSET-MESSUNG (SENSOR_OFFSET) 
# ═══════════════════════════════════════════════════════════════════
# Sensor-Auswahl (nur EINE Option aktiv lassen!)
#
# OPTION 1: Eigener Sensor-Pin 
sensor_pin: ^!PG14                    # Eigener Pin (! = invertiert: TRIGGERED=1, OPEN=0)
#
# OPTION 2: Existierender Sensor (z.B. von MMU)
#sensor_offset_path: mmu.sensors.toolhead     # Nutzt existierenden MMU Sensor


# Messparameter
sensor_offset_search_max: 5.0                # Max. Suchstrecke für Start-Position (mm)
sensorhub_safety_percent: 25                 # Sicherheitsaufschlag über Schaltabstand (%) - 0=exakt, 25=+25%


# ═══════════════════════════════════════════════════════════════════
# STATISTIK & WARTUNG
# ═══════════════════════════════════════════════════════════════════
measurement_count_milestone: 10              # Zähler für Statistik-Meilensteine (Anzahl Messungen)

# ═══════════════════════════════════════════════════════════════════
# AUSWERTUNG & VISUALISIERUNG
# ═══════════════════════════════════════════════════════════════════
create_plot: 1                               # PNG-Diagramme erstellen (1=an, 0=aus)
plot_path: ~/printer_data/config/Auto_Offset/Auswertung/  # Speicherort für Auswertungs-Dateien
plot_history_count: 10                       # Anzahl Messungen im History-Plot


# ═══════════════════════════════════════════════════════════════════
# LED HELPER MAKRO
# ═══════════════════════════════════════════════════════════════════
[gcode_macro SET_ALL_LEDS]
description: Setzt alle LEDs auf eine Farbe
gcode:
    {% set cfg = printer['auto_offset'] %}
    {% set led_name = cfg.led_name %}
    {% set r = params.RED|default(1.0)|float %}
    {% set g = params.GREEN|default(1.0)|float %}
    {% set b = params.BLUE|default(1.0)|float %}
    SET_LED LED={led_name} RED={r} GREEN={g} BLUE={b}


# ═══════════════════════════════════════════════════════════════════
# AUTO-LOAD BEIM BOOT
# ═══════════════════════════════════════════════════════════════════
[delayed_gcode AUTO_OFFSET_LOAD_ON_BOOT]
initial_duration: 5
gcode:
    {% set vars = printer.save_variables.variables|default({}) %}
    {% set saved_tap = vars.tap_last_distance|default(0.0)|float %}
    {% set saved_offset = vars.sensor_offset_value|default(0.0)|float %}
    RESPOND PREFIX="INFO" MSG="Geladene Werte: Schaltabstand={ '%.4f'|format(saved_tap) } mm | Z-Offset={ '%.4f'|format(saved_offset) } mm"
